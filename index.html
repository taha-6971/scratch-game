<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>بازی اسکرچ</title>
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#18181b" />
  <style>
    html, body { height: 100%; margin: 0; background:#0b0b0f; color:#fff; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    .wrap { display:flex; flex-direction:column; height:100%; }
    header { padding: 12px 16px; display:flex; align-items:center; gap:12px; }
    header img { width:28px; height:28px; border-radius:8px; }
    header h1 { font-size: 16px; margin:0; font-weight:600; }
    .info { font-size: 13px; opacity: .8; padding: 0 16px 10px; }
    iframe { flex:1; width:100%; border:0; background:#000; }
  </style>
  <script>
    // ثبت Service Worker برای نصب به عنوان وب‌اپ
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js');
      });
    }
  </script>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="./icons/icon-192.png" alt="icon">
      <h1>🎮 بازی اسکرچ</h1>
    </header>
    <div class="info">
      اگر بازی اجرا نشد، مطمئن شو فایل‌ها را روی GitHub Pages یا Netlify آپلود کرده‌ای.
    </div>
    <iframe id="player" allow="autoplay; fullscreen" allowfullscreen></iframe>
  </div>

  <script>
    const iframe = document.getElementById('player');

    async function loadGame() {
      try {
        // دریافت فایل sb3 از سرور خودت (بدون خطای CORS)
        const resp = await fetch('./game.sb3');
        const blob = await resp.blob();

        // تبدیل به Data URL
        const dataURL = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onloadend = () => resolve(reader.result);
          reader.readAsDataURL(blob);
        });

        // ساخت لینک TurboWarp با داده‌ی داخلی
        const embedUrl =
          'https://turbowarp.org/embed.html#' +
          'project_url=' + encodeURIComponent(dataURL) +
          '&autoplay&fps=60&turbo';

        iframe.src = embedUrl;
      } catch (e) {
        console.error('خطا در لود بازی:', e);
        iframe.outerHTML = '<p style="padding:16px;color:red;">خطایی در بارگذاری بازی رخ داد. لطفاً صفحه را رفرش کن.</p>';
      }
    }

    loadGame();
  </script>
</body>
</html>
